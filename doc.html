<!doctype html>
<html lang="ru">
  <head>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/documentation.css">
    <script type="text/javascript">
      var thePage = "doc";
    </script>
    <script type="text/javascript" src="javascripts/menu.js"></script>

    <meta charset="utf-8">
    <title>Проект Vintage &#151; Документация</title>

<!--     <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> -->

    <!-- Google Analytics script -->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-33475176-1']);
      _gaq.push(['_setDomainName', 'github.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

</head>
  <body>
    <script type="text/javascript">printMenu(window.thePage);</script>
        
    <div class="contents-frame">
      <div class="page">
          <h2>Содержание</h2>
          <ul>
            <li><span class="number">1.</span> <a href="#p1">Немного об особенностях архитектуры</a></li>
            <li><span class="number">2.</span> <a href="#p2">Стандартные устройства</a></li>
            <li><span class="number">2.1.</span> <a href="#p2-1">Vintage Processor Unit (VPU)</a></li>
            <li><span class="number">2.1.1.</span> <a href="#p2-1-1">Язык ассемблера VPU</a></li>
            <li><span class="number">2.1.2.</span> <a href="#p2-1-2">Инструкции ассемблера VPU</a></li>
          </ul>
      </div>
    </div>
    <div class="page">
        
        <a name="p1"><h2><span class="number">1.</span> Немного об особенностях архитектуры</h2></a>
        <p>Vintage &#151; машинная архитектура, предполагающая несколько устройств, работающих совместно в общем линейном адресном пространстве
        и взаимодействующих посредством передачи друг другу так называемого <em>контекста исполнения</em>. Каждое устройство имеет собственный независимый
        жизненный цикл и любое взаимодействие между устройствами осуществляется асинхронно.</p>
        
        <p>Для данной архитектуры была создана виртуальная машина Vintage VM, которую можно свободно <a href="downloads.html">скачать</a> на этом сайте.</p>
        
        <p>В качестве примера представим себе взаимодействие двух устройств &#151; процессора (на картинке &#151; PU) и экрана (Screen)</p>
        
        <div class="pic">
          <img src="images/documentation-1.png" />
          <div>Пример машины, состоящей из процессора (Processor Unit) и экрана</div>
        </div>
        
        <p>Под термином &laquo;контекст исполнения&raquo; следует понимать некоторую сущность, описывающую состояние исполнителя в данный момент времени. 
        Говоря конкретнее, в данном случае речь идет о сущности, полностью описывающей состояние процессора.</p>
        
        <p>Для того, чтобы вывести на экран некий текст, процессор формирует в памяти, заданной контекстом исполнения, команду, а затем передает контекст
        внешнему устройству, т.е. экрану. Экран, в свою очередь, считывает из этой памяти команду, выполняет ее и таким выводится текст.</p>
        
        <p>Следует заметить, что все процедуры происходят асинхронно, то есть пока экран выполняет команду, переданную ему процессором, 
        последний продолжает выполнение кода. Необходимо избежать изменение области памяти, в которой находится команда для экрана до момента,
        когда эта команда будет выполнена. За это отвечает основная программа. Экран рапортует о том, что команда выполнена успешно,
        передав процессору специальное сообщение.</p>
        
    </div>
    <div class="helper-frame">
      <div class="page">
        <p>Следует понимать, что в отличие от привычной машинной архитектуры, содержащей понятие <em>центральный процессор</em>, в случае
        Vintage такого понятия в общем случае нет. Несмотря на то, что системы, содержащие только один процессор, неминуемо опираются на него как
        на основной, в случае Vintage принципиально то, что все устройства равноценны с точки зрения своего взаимодействия. Ни 
        &laquo;главных&raquo;, ни &laquo;второстепенных&raquo; нет.</p>
      </div>
    </div>
    <div class="page">

        <a name="p2"><h2><span class="number">2.</span> Стандартные устройства</h2></a>
        Здесь будет описание ряда стандартных устройств, поддержка которых предполагается в дальнейшем.
        <a name="p2-1"><h3><span class="number">2.1.</span> Vintage Processor Unit (VPU)</h3></a>
        <p>Основным компонентом любой программируемой системы является процессор. В архитектуре Vintage процессор принимает и передает сообщения прочим 
        устройствам. Процессор исполняет машинные команды, записанные в память. Для того, чтобы запустить исполнение, процессор должен получить сообщение,
        содержащее контекст, который ему следует исполнять. Обсуждаемая реализация процессора VPU имеет 32х-разрядную архитектуру, то есть длина адреса
        памяти составляет 4 байта.</p>
        <p>Контекст процессора делит память на две части &#151; хип (heap) и стек (stack). Адресация хипа абсолютна, то есть адрес 0 соответствует
        самому началу выделенной под него части памяти. Адресация стека ведется относительно его вершины, которую можно двигать, забирая или освобождая под него память.
        Все сиюминутные операции процессор производит в стеке.</p>
        
        <a name="p2-1-1"><h3><span class="number">2.1.1.</span> Язык ассемблера VPU</h3></a>
        
        <p>Для программирования под процессор VPU был придуман язык ассемблера, транслируемый прямо, инструкция за инструкцией, в машинный код. 
        Синтаксис этого языка достаточно прост:</p>
        
        <div class="codeframe">
          <code>          <span class="instr">instr1</span> <span class="param">{param1}</span>, <span class="param">[{param2}]</span>, <span class="param optional">param3</span></code> 
          <code><span class="label">label:    </span><span class="instr">instr2</span> <span class="param">{param1}</span>                         <span class="comment">; comment</span></code> 
        </div>
        
        <p>instr1 и instr2 здесь &#151; инструкции. Каждая (или почти каждая) инструкция, как и в любом языке ассемблера, означает одно действие, выполняемое
        процессором. После инструкции следует пробел, за которым через запятую перечислены параметры. Параметры бывают константами или одним из двух вариантов 
        указателей. Указатель может указывать либо на стек, либо на хип.</p>
        <ol>
          <li>Синтаксис вида <span class="codeframe"><code><span class="param">param</span></code></span> (без скобок) означает, что величина будет 
          воспринята процессором как константа.</li>
          <li>Синтаксис вида <span class="codeframe"><code><span class="param">{param}</span></code></span> (в фигурных скобках) означает, что 
          будет использован указатель на ячейку стека с номером param.</li>
          <li>Синтаксис вида <span class="codeframe"><code><span class="param">[{param}]</span></code></span> (в фигурных и квадратных скобках) означает, что 
          будет использован указатель на ячейку хипа, адрес которой равен значению, взятому из стека по адресу param.</li>
        </ol>
        
    </div>
    <div class="helper-frame">
      <div class="page">
        Для удобства можно читать параметры &laquo;изнутри наружу&raquo;. Например, рассмотрим последний вариант: 
        <span class="codeframe"><code><span class="param">[{param}]</span></code></span>. Алгоритм разбра будет такой:
        <ol>
          <li>Берем значение param.</li>
          <li>Видим фигурные скобки, значит берем значение из стека по адресу, равному имеющемуся значению. Полученную величину запомним.</li>
          <li>Видим квадратные скобки, значит берем значение из хипа по адресу, равному имеющемуся значению. Полученная величина &#151; и есть ответ.</li>
        </ol>
      </div>
    </div>
    <div class="page">

        <p>Каждые скобки означают операцию взятия значения по заданному внутри скобок адресу. Фигурные &#151; из стека, квадратные &#151; из хипа.</p>
        
        <p>Перед инструкцией может находиться метка, отделенная двоеточием. Метка позволяет помечать позицию в коде, на которую впоследствии будет совершен
        переход (например,         
        <span class="codeframe"><code><span class="instr">jmp</span></code></span> или 
        <span class="codeframe"><code><span class="instr">call</span></code></span>). 
        Будучи подставленной куда-либо в качестве параметра, 
        метка заменяется на адрес хипа, по которому начинается инструкция, следующая за данной меткой.</p>
        
        <p>Любой текст после знака <span class="codeframe"><code>;</code></span> (точка с запятой) 
        будет считаться комментарием в коде и игнорироваться до конца строки.</p>
        
        <p>И наконец, обратим внимание на запись <span class="codeframe"><code><span class="param optional">param3</span></code></span>
        (параметр, записанный курсивом). Условимся здесь и далее, что параметры, указанные курсивом, являются необязательными, то есть в
        нашем случае инструкция <span class="codeframe"><code><span class="instr">instr1</span></code></span> может быть вызвана как с тремя, так
        и с двумя параметрами</p>
        
        <a name="p2-1-2"><h3><span class="number">2.1.2.</span> Инструкции ассемблера VPU</h3></a>
        В этом разделе приводятся машинные команды VPU, записанные в виде инструкций на языке ассемблер. В соответствии с vasm-синтаксисом значения, 
        заключенные в фигурные скобки (как {dest}), являются указателями  
        <table cellpadding=0 cellspacing=0 class="commands">
          <thead>
            <td>Команда</td><td>Описание</td>
          </thead>

          <tr>
          	<td class="codeframe" style="border-left-width: 0; border-top-width: 0">
              <code><span class="instr">alloc</span> <span class="param">bytes</span></code><br/>
          	</td>
          	<td>
          	  <p class="title">Allocate &#151; выделить память в стеке.</p>
          	  Сдвигает вершину стека на <span class="codeframe"><code><span class="param">bytes</span></code></span> байтов влево.
          	  Таким образом значение, которое находилось по адресу <span class="codeframe"><code>{0}</code></span>, после выполнения
          	  данной команды окажется в <span class="codeframe"><code>{bytes}</code></span>, а перед ним окажется соответственное
          	  количество &laquo;выделенных&raquo; байтов.</p>
          	  <p>Никаких гарантий касаемо содержимого выделенной памяти не представляется. Там может быть что угодно. Таким образом
          	  перед использованием, ее следует инициализировать какими-нибудь значениями.</p>
          	</td>
          </tr>

          <tr>
          	<td class="codeframe" style="border-left-width: 0; border-top-width: 0">
              <code><span class="instr">free</span> <span class="param">bytes</span></code><br/>
          	</td>
          	<td>
          	  <p class="title">Free &#151; освободить стековую память.</p>
          	  <p>Сдвигает вершину стека на <span class="codeframe"><code><span class="param">bytes</span></code></span> байтов вправо.
          	  Таким образом значение, которое находилось по адресу <span class="codeframe"><code>{bytes}</code></span>, после выполнения
          	  данной команды окажется в <span class="codeframe"><code>{0}</code></span>, а все данные, находившиеся перед ним,
          	  будут уничтожены.</p>
          	</td>
          </tr>

          <tr>
          	<td class="codeframe" style="border-left-width: 0; border-top-width: 0">
              <code><span class="instr">mov</span> <span class="param optional">bytes</span>, <span class="param">{dest}</span>, <span class="param">src</span></code><br/>
              <code><span class="instr">mov</span> <span class="param optional">bytes</span>, <span class="param">[{dest}]</span>, <span class="param">{src}</span></code><br/> 
              <code><span class="instr">mov</span> <span class="param optional">bytes</span>, <span class="param">{dest}</span>, <span class="param">[{src}]</span></code> <br/>
          	</td>
          	<td>
          	  <p class="title">Move &#151; переместить значения в памяти.</p>
          	  <p>Копирует <span class="codeframe"><code><span class="param">bytes</span></code></span> памяти из 
          	  <span class="codeframe"><code><span class="param">src</span></code></span> в 
          	  <span class="codeframe"><code><span class="param">dest</span></code></span>. 
          	  Параметр <span class="codeframe"><code><span class="param optional">bytes</span></code></span> является необязательным параметром.
          	  Если он не указан, по умолчанию используется
          	  длина адреса (4 байта).</p> 
          	  
          	  <p>В данной версии поддерживаются только длины 1, 2, 4 и 8 байтов.</p>
          	</td>
          </tr>

        </table>
    </div>
  </body>
  
</html>